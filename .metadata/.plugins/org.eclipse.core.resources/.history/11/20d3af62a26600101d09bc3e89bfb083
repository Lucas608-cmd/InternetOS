package cn.org.act.internetos.manage.app;

import java.io.IOException;
import java.io.StringReader;
import java.util.Iterator;
import java.util.List;

import org.dom4j.Attribute;
import org.dom4j.CDATA;
import org.dom4j.Comment;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.dom4j.DocumentType;
import org.dom4j.Element;
import org.dom4j.Entity;
import org.dom4j.Namespace;
import org.dom4j.Node;
import org.dom4j.ProcessingInstruction;
import org.dom4j.Text;
import org.dom4j.Visitor;
import org.dom4j.io.SAXReader;
import org.xml.sax.InputSource;


import cn.org.act.internetos.persist.Application;
import cn.org.act.internetos.signal.HttpSignalListener;
import cn.org.act.internetos.signal.MatchRule;
import cn.org.act.internetos.signal.Signal;
import cn.org.act.internetos.signal.SignalListener;

public class ConfigParser {
//	public static void parseBooks(){     
//        
//        SAXReader reader = new SAXReader();     
//        try {     
//            Document doc = reader.read("d:\\1.txt");     
//            Node root = doc.selectSingleNode("/books");     
//            List list = root.selectNodes("book[@url='dom4j.com']");     
//                
//            for(Object o:list){     
//                    
//                Element e = (Element) o;     
//                String show=e.attributeValue("show");     
//                System.out.println("show = " + show);     
//            }     
//               
//        } catch (Exception e) {     
//            e.printStackTrace();     
//        }     
//    }    
	public static void main(String[] args){
		//parseBooks();
		String config = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"+
		"<Application>"+
		"<Name>Test</Name>"+
		"<Listeners>"+
			"<HttpListener>"+
					"<URL>http://localhost:8080/DemoApp/listener</URL>"+
					"<MatchRule type=\"urlregex\">"+
						".*/signal/send.*"+
					"</MatchRule>"+
			"</HttpListener>"+
		"</Listeners>"+
	"</Application>";
		new Application("a",config);
	}
	public static void Parse(
			Application app) {
		String config = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"+
		"<Application>"+
		"<Name>Test</Name>"+
		"<Listeners>"+
			"<HttpListener>"+
					"<URL>http://localhost:8080/DemoApp/listener</URL>"+
					"<MatchRule type=\"urlregex\">"+
						".*/signal/send.*"+
					"</MatchRule>"+
			"</HttpListener>"+
		"</Listeners>"+
	"</Application>";
		
		app.setConfig(config);
		try {
			
			Document document =DocumentHelper.parseText(app.getConfig());
			Element application = document.getRootElement();
			
			app.setName(application.elementText("Name"));
			
			//XPath is not avaliable in dom4j of xstream
			//List<Node> listeners = document.selectNodes("/application/listeners");
			
			@SuppressWarnings("unchecked")
			List<Element> listeners = application.element("Listeners").elements();
			
			for(Element node : listeners){
				app.getListeners().add(ListenerFactory.createListener(node));
			}
		} catch (DocumentException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		

	}
	
}
